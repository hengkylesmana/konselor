<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teman Curhat RASA</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00695c">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS Anda tidak berubah, jadi saya singkat untuk keringkasan */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        :root {
            --bg-calm: linear-gradient(135deg, #b3e5a3 0%, #68b851 100%);
            --container-bg: rgba(255, 255, 255, 0.95);
            --user-msg-bg: #e2ffc7;
            --ai-msg-bg: #f3f3f3;
            --primary-text: #2c3e50;
            --secondary-text: #597a6e;
            --accent-color: #00695c;
            --border-color: #e0e0e0;
            --shadow: 0 6px 24px 0 rgba(0, 0, 0, 0.15);
            --danger-color: #d32f2f;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-calm); margin: 0; padding: 10px; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: var(--primary-text); }
        .container { width: 100%; max-width: 700px; height: 95vh; background: var(--container-bg); border-radius: 20px; box-shadow: var(--shadow); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid #cccccc; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s; }
        header:hover { background-color: rgba(0,0,0,0.03); }
        .header-content { display: flex; align-items: center; gap: 12px; }
        header .logo { display: none; }
        .title-group { text-align: left; }
        .title-group h1 { margin: 0; font-size: 1.2rem; color: var(--accent-color); font-weight: 600; }
        .title-group p { margin: 1px 0 0 0; font-size: 0.65rem; color: var(--secondary-text); }
        .chat-container { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-message { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; word-wrap: break-word; font-size: 0.9rem; }
        .ai-message h3 { margin-top: 0; margin-bottom: 8px; color: var(--accent-color); font-size: 1.1rem; }
        .ai-message ul { padding-left: 20px; margin: 10px 0; }
        .ai-message li { margin-bottom: 5px; }
        .ai-message p { margin: 0 0 10px 0; }
        .ai-message p:last-child { margin-bottom: 0; }
        .ai-message hr { border: none; border-top: 1px solid var(--border-color); margin: 15px 0; }
        .chat-link { color: var(--accent-color); text-decoration: underline; font-weight: 600; }
        .choice-container { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
        .choice-button { width: 100%; background-color: white; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 10px; border-radius: 8px; text-align: left; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-weight: 500; font-size: 0.85rem; }
        .choice-button:hover:not(:disabled) { background-color: var(--accent-color); color: white; }
        .choice-button.selected { background-color: var(--accent-color); color: white; }
        .choice-button:disabled { background-color: #e0e0e0; border-color: #bdbdbd; color: #9e9e9e; cursor: not-allowed; opacity: 0.7; }
        .user-message { background-color: var(--user-msg-bg); align-self: flex-end; color: #3e612d; }
        .ai-message, .ai-system-message { background-color: var(--ai-msg-bg); align-self: flex-start; }
        .ai-system-message { font-style: italic; color: var(--secondary-text); width: 100%; text-align: center; max-width: 100%; background-color: transparent; padding: 0; }
        .input-container { display: flex; padding: 10px; border-top: 1px solid var(--border-color); gap: 8px; align-items: center; flex-shrink: 0; }
        #user-input { flex: 1; min-width: 0; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--border-color); resize: none; font-family: 'Poppins', sans-serif; font-size: 0.9rem; line-height: 1.4; max-height: 100px; overflow-y: auto; }
        #user-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(0, 105, 92, 0.2); }
        #send-btn, #voice-btn, #end-chat-btn { flex-shrink: 0; width: 40px; height: 40px; border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease-in-out; }
        #send-btn:hover, #voice-btn:hover { transform: scale(1.1); }
        #send-btn, #voice-btn { background-color: var(--accent-color); }
        #end-chat-btn { background-color: var(--secondary-text); font-weight: 600; font-size: 0.7rem; padding: 0; }
        #voice-btn.recording { background-color: var(--danger-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 5px 10px rgba(211, 47, 47, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }
        .status-info { padding: 0 20px 8px; font-size: 0.75rem; color: var(--secondary-text); text-align: center; min-height: 1rem; }
        footer { padding: 8px 20px; text-align: center; color: var(--secondary-text); background-color: rgba(0,0,0,0.02); border-top: 1px solid var(--border-color); flex-shrink: 0; }
        footer p { margin: 0; font-size: 0.6rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-calm); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 1; transition: opacity 0.5s ease, visibility 0.5s; visibility: visible; }
        .modal-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .start-content { text-align: center; padding: 24px; background-color: white; border-radius: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; max-width: 90%; width: 400px; box-sizing: border-box; }
        .start-content .logo { margin-bottom: 16px; }
        .start-title { font-size: 1.8rem; color: #000000; margin: 8px 0; font-weight: 600; }
        .start-subtitle { font-size: 0.8rem; color: #000000; font-weight: 400; margin-bottom: 16px; }
        .info-box { max-height: 120px; overflow-y: auto; background-color: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; text-align: left; font-size: 0.8rem; color: #333; margin-bottom: 20px; line-height: 1.6; }
        .info-box p { margin: 0 0 10px 0; }
        .info-box p:last-child { margin-bottom: 0; }
        .start-button-group { display: flex; flex-direction: column; justify-content: center; gap: 10px; width: 100%; }
        .start-content .modal-button { background-color: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: transform 0.2s, background-color 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; line-height: 1.3; }
        .start-content .modal-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .start-content .modal-button.secondary { background-color: transparent; color: var(--accent-color); border: 2px solid var(--accent-color); }
    </style>
</head>
<body>
    <!-- Layar Pembuka / Modal -->
    <div id="start-overlay" class="modal-overlay visible">
        <div class="start-content">
            <svg class="logo" width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="goldGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                        <stop offset="0%" style="stop-color:#FFDF00;stop-opacity:1" />
                        <stop offset="60%" style="stop-color:#FFD700;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#B8860B;stop-opacity:1" />
                    </radialGradient>
                </defs>
                <circle cx="50" cy="50" r="48" fill="url(#goldGradient)" stroke="#DAA520" stroke-width="2"/>
                <path d="M50 75 C 40 65, 25 55, 25 42.5 C 25 32.5, 35 25, 50 35 C 65 25, 75 32.5, 75 42.5 C 75 55, 60 65, 50 75 Z" fill="#FFFFFF" fill-opacity="0.8"/>
            </svg>
            <h2 class="start-title">Teman Curhat RASA</h2>
            <p class="start-subtitle">Ruang Asuh Sadar Asa</p>
            
            <div class="info-box">
                <p>Anda bisa curhat atau sekedar ngobrol berbagai hal dengan Teman Curhat online yang bernama RASA. Ceritakan saja isi hatimu, sukamu, dukamu, masalahmu atau apa harapanmu. RASA akan berusaha menjadi teman setiamu, pendengar setiamu, bahkan pembantu setiamu.</p>
                <p><strong>Tenang saja, ini privat dan rahasia.</strong> Semua riwayat percakapan bersifat rahasia, dan tidak ada seorang lain pun yang bisa membacanya. Sistem AI otomatis akan menghapus semua riwayat percakapan pada saat sesi curhat berakhir.</p>
            </div>
            
            <div class="start-button-group">
                <button id="start-curhat-umum" class="modal-button start-curhat-action">Curhat Yuk - Aku sama Sepertimu</button>
                <button id="start-curhat-dokter" class="modal-button start-curhat-action">Tanya ke Dokter AI – Bantu Pahami Gejala Lebih Cepat</button>
                <button id="start-curhat-ngaji" class="modal-button start-curhat-action">Tanya ke Sahabat Ngaji – Bantu Temukan Rujukan Islami</button>
                <button id="start-curhat-psikolog" class="modal-button start-curhat-action">Tanya ke Psikolog AI – Pahami Perasaanmu, Bantu Tenangkan</button>
                <button id="start-curhat-insinyur" class="modal-button start-curhat-action">Tanya ke Insinyur AI – Ngobrol Ringan, Ngobrolin Solusi</button>
                <button id="start-test-btn" class="modal-button secondary">Mulai Tes Kepribadian</button>
            </div>
        </div>
    </div>

    <!-- Konten Aplikasi Utama -->
    <div class="container">
        <header>
            <div class="header-content">
                <div class="title-group">
                    <h1>Teman Curhat RASA</h1>
                    <p>Ruang Asuh Sadar Asa - Teman Curhat Psikis dan Spiritual Berbasis AI Terlatih</p>
                </div>
            </div>
        </header>

        <div class="chat-container" id="chat-container"></div>

        <div class="input-container">
            <textarea id="user-input" placeholder="Tulis curhatmu di sini..." rows="1"></textarea>
            <button id="send-btn" title="Kirim Pesan">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
            <button id="voice-btn" title="Mulai Bicara">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
            </button>
            <button id="end-chat-btn" title="Batalkan Respon">SKIP</button>
        </div>
        
        <div id="status" class="status-info"></div>
        
        <footer>
            <p>© 2025 Teman Curhat RASA versi 1.0 — Powered by AI & Insight Spiritual | by Hengky Lesmana</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === DOM ELEMENT SELECTION ===
            const chatContainer = document.getElementById('chat-container');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const voiceBtn = document.getElementById('voice-btn');
            const endChatBtn = document.getElementById('end-chat-btn');
            const statusDiv = document.getElementById('status');
            const startOverlay = document.getElementById('start-overlay');
            const startCurhatBtns = document.querySelectorAll('.start-curhat-action');
            const startTestBtn = document.getElementById('start-test-btn');
            const header = document.querySelector('header');
            const headerTitle = header.querySelector('.title-group h1');
            const headerSubtitle = header.querySelector('.title-group p');
            
            // === APPLICATION STATE ===
            let conversationHistory = []; 
            let speechVoices = [];
            let abortController = null;
            let recognition = null;
            let isRecording = false;
            let audioContext = null;
            let userName = '', userGender = 'Pria', userAge = '';
            let isOnboarding = false;
            let isTesting = false;
            let currentTestType = null;
            let testData = {};
            let testScores = {};
            let currentTestQuestionIndex = 0;
            // PENYESUAIAN 1: Tambahkan state untuk persona saat ini
            let currentPersona = 'umum'; 

            // PENYESUAIAN 2: Buat objek konfigurasi untuk setiap persona
            const personaConfig = {
                'start-curhat-umum': {
                    id: 'umum',
                    title: 'Teman Curhat RASA',
                    subtitle: 'Ruang Asuh Sadar Asa - Teman Curhat Psikis dan Spiritual Berbasis AI Terlatih',
                    skipOnboarding: false // Sesi perkenalan akan dijalankan
                },
                'start-curhat-dokter': {
                    id: 'dokter',
                    title: 'Tanya ke Dokter AI – Bantu Pahami Gejala Lebih Cepat',
                    subtitle: 'Saya adalah AI yang dilatih dengan pengetahuan ilmu kedokteran.',
                    welcomeMessage: 'Assalamualaikum. Silakan jelaskan gejala atau keluhan medis yang Anda rasakan. Saya akan coba bantu memahaminya. Disclaimer: Saya bukan dokter sungguhan, informasi ini hanya untuk edukasi.',
                    skipOnboarding: true // Langsung ke sesi curhat
                },
                'start-curhat-ngaji': {
                    id: 'ngaji',
                    title: 'Tanya ke Sahabat Ngaji',
                    subtitle: 'Bantu Temukan Rujukan Islami',
                    welcomeMessage: 'Assalamualaikum. Ada pertanyaan atau keresahan seputar keislaman yang bisa kita diskusikan bersama? Insya Allah saya coba bantu carikan rujukan.',
                    skipOnboarding: true
                },
                'start-curhat-psikolog': {
                    id: 'psikolog',
                    title: 'Tanya ke Psikolog AI',
                    subtitle: 'Pahami Perasaanmu, Bantu Tenangkan',
                    welcomeMessage: 'Assalamualaikum. Selamat datang di ruang yang aman untuk bercerita. Apa yang sedang Anda rasakan atau pikirkan saat ini?',
                    skipOnboarding: true
                },
                'start-curhat-insinyur': {
                    id: 'insinyur',
                    title: 'Tanya ke Insinyur AI',
                    subtitle: 'Ngobrol Ringan, Ngobrolin Solusi',
                    welcomeMessage: 'Assalamualaikum. Ada masalah teknis, proyek, atau ide inovatif yang ingin didiskusikan? Mari kita pecahkan bersama.',
                    skipOnboarding: true
                }
            };

            // Data tes tidak berubah, jadi disingkat
            const fullTestData = { /* ... data tes lengkap Anda di sini ... */ };

            // === INITIALIZATION & EVENT LISTENERS ===
            function init() {
                if ('serviceWorker' in navigator) {
                  window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js');
                  });
                }
                loadVoices();
                displayInitialMessage();
                updateButtonVisibility();
                
                // PENYESUAIAN 3: Ubah event listener untuk menangani persona yang berbeda
                startCurhatBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const config = personaConfig[e.currentTarget.id];
                        if (config) {
                            initializeApp(false, config);
                        }
                    });
                });

                startTestBtn.addEventListener('click', () => initializeApp(true));
                header.addEventListener('click', () => window.location.reload());
                sendBtn.addEventListener('click', handleSendMessage);
                voiceBtn.addEventListener('click', toggleMainRecording);
                endChatBtn.addEventListener('click', handleCancelResponse);
                
                userInput.addEventListener('input', () => {
                    userInput.style.height = 'auto';
                    userInput.style.height = (userInput.scrollHeight) + 'px';
                    updateButtonVisibility();
                });

                userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                });
            }
            
            // PENYESUAIAN 4: Modifikasi initializeApp untuk menerima konfigurasi persona
            function initializeApp(startWithTest = false, personaConf = personaConfig['start-curhat-umum']) {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch(e) { console.error("Web Audio API tidak didukung."); }
                }
                startOverlay.classList.add('hidden');
                chatContainer.innerHTML = '';
                
                // Atur state persona saat ini
                currentPersona = personaConf.id;

                // Atur header sesuai persona
                headerTitle.textContent = personaConf.title;
                headerSubtitle.textContent = personaConf.subtitle;

                if (startWithTest) {
                    isTesting = true;
                    // ... logika tes tidak berubah
                } else {
                    isTesting = false;
                    // Cek apakah perlu melewati sesi perkenalan
                    if (personaConf.skipOnboarding) {
                        // Langsung tampilkan pesan selamat datang spesifik
                        displayMessage(personaConf.welcomeMessage, 'ai');
                        speakAsync(personaConf.welcomeMessage.replace(/Disclaimer:.*$/i, ''), true); // Baca pesan tanpa disclaimer
                    } else {
                        // Jalankan sesi perkenalan seperti biasa
                        startOnboardingIfNeeded();
                    }
                }
            }

            // Fungsi startOnboardingIfNeeded dan logika tes lainnya tidak berubah
            // ...

            // === CORE MESSAGE HANDLING & UI ===
            async function handleSendMessage() {
                // ... logika fungsi ini tidak berubah
                if (isRecording || isOnboarding || isTesting) return;
                const userText = userInput.value.trim();
                if (!userText) return;

                displayMessage(userText, 'user');
                userInput.value = '';
                userInput.style.height = 'auto';
                updateButtonVisibility();
                await getAIResponse(userText, userName, userGender, userAge);
            }
            
            function handleSendMessageWithChoice(choice) {
                // ... logika fungsi ini tidak berubah
            }

            // ... (Fungsi UI, recording, dll tidak berubah)
            
            // PENYESUAIAN 5: Modifikasi getAIResponse untuk mengirim data persona
            async function getAIResponse(prompt, name, gender, age) {
                abortController = new AbortController();
                statusDiv.textContent = "RASA sedang berpikir...";
                updateButtonVisibility();
                
                let responseText = "";

                try {
                    const apiResponse = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // Tambahkan 'persona: currentPersona' ke body permintaan
                        body: JSON.stringify({ prompt, name, gender, age, history: conversationHistory, persona: currentPersona }),
                        signal: abortController.signal
                    });
                    if (!apiResponse.ok) throw new Error(`Server merespon dengan status ${apiResponse.status}`);
                    const result = await apiResponse.json();
                    responseText = result.aiText || `Terima kasih sudah berbagi. B
